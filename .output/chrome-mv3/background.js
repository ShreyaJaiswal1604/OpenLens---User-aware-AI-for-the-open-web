var background=(function(){"use strict";function K(o){return o==null||typeof o=="function"?{main:o}:o}const E=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome,$="permissions";function S(){return new Promise(o=>{chrome.storage.local.get($,c=>{o(c?.[$]||[])})})}function N(o){return new Promise(c=>{chrome.storage.local.set({[$]:o},()=>c())})}async function Y(o,c,l){const s=await S(),O=Date.now();return s.find(h=>{if(h.type!==o||h.expiresAt&&h.expiresAt<O)return!1;switch(h.scope){case"page":return h.tabId===l&&h.origin===c;case"site":return h.origin===c;case"session":return!0}})||null}async function M(o,c,l,s){const O=await S(),h=Date.now(),A={type:o,scope:c,origin:l,tabId:s,grantedAt:h,expiresAt:c==="page"?null:h+1800*1e3},b=O.filter(L=>!(L.type===o&&L.origin===l&&L.tabId===s));return b.push(A),await N(b),A}async function z(o){const l=(await S()).filter(s=>s.tabId!==o);await N(l)}async function B(o){const l=(await S()).filter(s=>!(s.scope==="page"&&s.tabId===o));await N(l)}async function H(o){const c=await S(),l=Date.now();return c.filter(s=>!(s.expiresAt&&s.expiresAt<l||o!==void 0&&s.tabId!==o))}const x={read_page:{name:"read_page",description:"Extract and summarize the current page content",requiredPermission:"page_read",isWriteAction:!1},extract_data:{name:"extract_data",description:"Extract structured data (prices, links, forms, headings) from the page",requiredPermission:"page_read",isWriteAction:!1},find_on_page:{name:"find_on_page",description:"Search for specific text on the page",requiredPermission:"page_read",isWriteAction:!1,params:{query:"Text to search for"}},navigate:{name:"navigate",description:"Open a URL in a new tab",requiredPermission:"page_action",isWriteAction:!0,params:{url:"URL to open"}},fill_form:{name:"fill_form",description:"Fill form fields (user must submit manually)",requiredPermission:"page_action",isWriteAction:!0,params:{fields:"Object of field name â†’ value pairs"}},click_element:{name:"click_element",description:"Click a link or button by selector or text",requiredPermission:"page_action",isWriteAction:!0,params:{selector:"CSS selector or text content to match"}}},X={read_page:{max_tokens:{type:"number",description:"Maximum tokens to extract (default 2000)"}},extract_data:{data_type:{type:"string",description:"Type of data to extract: prices, links, forms, or headings"}},find_on_page:{query:{type:"string",description:"Text to search for on the page"}},navigate:{url:{type:"string",description:"URL to open in a new tab"}},fill_form:{fields:{type:"string",description:"JSON object of field name to value pairs"}},click_element:{selector:{type:"string",description:"CSS selector or visible text of the element to click"}}};function V(){return Object.values(x).map(o=>{const c=X[o.name]||{},l=o.name==="find_on_page"?["query"]:o.name==="navigate"?["url"]:o.name==="click_element"?["selector"]:o.name==="fill_form"?["fields"]:[];return{type:"function",function:{name:o.name,description:o.description,parameters:{type:"object",properties:c,required:l}}}})}function Q(o){return o.filter(c=>c.enabled).map(c=>({type:"function",function:{name:c.id,description:c.description,parameters:{type:"object",properties:Object.fromEntries(Object.entries(c.params).map(([l,s])=>[l,{type:s.type,description:s.description}])),required:Object.keys(c.params)}}}))}function Z(o){return[...V(),...Q(o)]}const I="customTools";function R(){return new Promise(o=>{chrome.storage.local.get(I,c=>{o(c?.[I]||[])})})}function j(o){return new Promise(c=>{chrome.storage.local.set({[I]:o},()=>c())})}async function U(){return R()}async function ee(o){const c=await R(),l=c.findIndex(s=>s.id===o.id);l>=0?c[l]=o:c.push(o),await j(c)}async function te(o){const c=await R();await j(c.filter(l=>l.id!==o))}const ne=K(()=>{let o={provider:"ollama",model:""};async function c(t,n){const{provider:e,model:a,apiKey:u,ollamaEndpoint:d}=o;switch(console.log("[AgentLens] llmChat called, provider:",e,"model:",a,"tools:",n?.tools?.length||0),e){case"ollama":{const i=d||"http://localhost:11434",p={model:a,messages:t,stream:!1};n?.tools?.length&&(p.tools=n.tools);const r=await fetch(`${i}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)});if(!r.ok)throw new Error(`Ollama error: ${r.status}`);const f=await r.json();return{content:f.message?.content||"",processingLocation:"local",toolCalls:f.message?.tool_calls||void 0}}case"openai":{const i=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${u}`},body:JSON.stringify({model:a,messages:t,max_tokens:1024})});if(!i.ok)throw new Error(`OpenAI error: ${i.status}`);return{content:(await i.json()).choices?.[0]?.message?.content||"",processingLocation:"cloud"}}case"anthropic":{const i=t.find(g=>g.role==="system")?.content||"",p=t.filter(g=>g.role!=="system"),r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":u,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify({model:a,max_tokens:1024,system:i,messages:p})});if(!r.ok)throw new Error(`Anthropic error: ${r.status}`);return{content:(await r.json()).content?.[0]?.text||"",processingLocation:"cloud"}}case"openrouter":{const i=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${u}`,"HTTP-Referer":"https://agentlens.dev","X-Title":"AgentLens"},body:JSON.stringify({model:a,messages:t,max_tokens:1024})});if(!i.ok)throw new Error(`OpenRouter error: ${i.status}`);return{content:(await i.json()).choices?.[0]?.message?.content||"",processingLocation:"cloud"}}default:throw new Error(`Unknown provider: ${e}`)}}let l=null,s={sessionId:`sess_${Date.now()}`,totalTokens:0,contextUsed:0,contextLimit:8192,selectedModel:"",provider:"ollama",processingLocation:"idle",dataEntries:[],auditEvents:[],insights:[]};chrome.storage.local.get("setupConfig",t=>{if(t.setupConfig){const n=t.setupConfig;s.selectedModel=n.selectedModel,s.provider=n.provider||"ollama",s.contextLimit=n.contextLength||8192,o={provider:n.provider||"ollama",model:n.selectedModel,apiKey:n.apiKey,ollamaEndpoint:n.ollamaEndpoint},console.log("[AgentLens] Config loaded:",o.provider,o.model)}}),chrome.storage.onChanged.addListener(t=>{if(t.setupConfig?.newValue){const n=t.setupConfig.newValue;s.selectedModel=n.selectedModel,s.provider=n.provider||"ollama",s.contextLimit=n.contextLength||8192,o={provider:n.provider||"ollama",model:n.selectedModel,apiKey:n.apiKey,ollamaEndpoint:n.ollamaEndpoint},console.log("[AgentLens] Config updated:",o.provider,o.model)}});function O(t){const n={...t,id:`de_${Date.now()}_${Math.random().toString(36).slice(2,6)}`,timestamp:Date.now()};s.dataEntries.push(n),s.totalTokens+=t.tokenCount||0,s.contextUsed+=t.tokenCount||0,A()}function h(t){const n={...t,id:`ae_${Date.now()}_${Math.random().toString(36).slice(2,6)}`,timestamp:Date.now()};s.auditEvents.push(n),A()}function A(){chrome.storage.local.set({sessionState:s}),chrome.tabs.query({},t=>{for(const n of t)n.id&&_(n.id,{type:"STATE_UPDATE",state:s}).catch(()=>{})})}chrome.tabs.onRemoved.addListener(t=>{z(t)}),chrome.tabs.onUpdated.addListener((t,n)=>{n.url&&B(t)});async function b(t,n,e,a,u){if(await Y(n,e,t))return!0;const i=o.provider==="ollama",p=i?"local":"cloud";if(i&&n==="page_read")return await M(n,"session",e,t),h({type:"permission_granted",origin:e,detail:{permType:n,scope:"session",autoGranted:!0,reason:"Local processing â€” data stays on device"},userAction:"auto",processingLocation:p}),console.log("[AgentLens] Auto-granted page_read (local provider, no cloud risk)"),!0;h({type:"permission_requested",origin:e,detail:{permType:n,reason:a,sensitivity:u},processingLocation:p});try{const r=await _(t,{type:"SHOW_PERMISSION_DIALOG",permType:n,reason:a,sensitivity:u});return r?.granted?(await M(n,r.scope,e,t),h({type:"permission_granted",origin:e,detail:{permType:n,scope:r.scope},userAction:"approved",processingLocation:p}),!0):(h({type:"permission_denied",origin:e,detail:{permType:n},userAction:"denied",processingLocation:p}),!1)}catch(r){return console.error("[AgentLens] Permission dialog error:",r),i&&n==="page_action"?(await M(n,"page",e,t),h({type:"permission_granted",origin:e,detail:{permType:n,scope:"page",autoGranted:!0,reason:"Dialog unavailable, local provider"},processingLocation:p}),!0):!1}}function L(t){const n=t.toLowerCase(),e=[];e.push({id:1,title:"Read current page",description:"Extract and analyze the content of this page",tool:"read_page",requiredPermission:"page_read",status:"pending",isWriteAction:!1,tokens:0});const a=n.match(/find|search|look for|where is|show me|locate/),u=t.replace(/^.*?(find|search for|look for|where is|show me|locate)\s*/i,"").split(/[.,!?]/)[0].trim();return a&&u.length>2&&e.push({id:2,title:`Search for "${u.slice(0,40)}"`,description:`Find "${u}" on this page`,tool:"find_on_page",toolParams:{query:u},requiredPermission:"page_read",status:"pending",isWriteAction:!1,tokens:0}),e.push({id:e.length+1,title:"Analyze and respond",description:`Use page content to answer: "${t}"`,tool:"read_page",requiredPermission:"page_read",status:"pending",isWriteAction:!1,tokens:0}),e}async function se(t){if(!o.model)return console.log("[AgentLens] No model configured, using fallback plan"),L(t);const n=Object.values(x).map(e=>`- ${e.name}: ${e.description} (permission: ${e.requiredPermission}, write: ${e.isWriteAction})`).join(`
`);try{console.log("[AgentLens] Generating plan via LLM...");const e=c([{role:"system",content:`You are a browser agent planner. Given a user intent, create a plan using available tools.

Available tools:
${n}

Output a JSON array of steps, each with:
- "title": short action title
- "description": what this step does
- "tool": tool name from the list above
- "toolParams": optional params object (e.g. {"query": "text"} for find_on_page)

Rules:
- Always start with read_page or extract_data
- Use find_on_page for specific searches
- Only use write actions (navigate, fill_form, click_element) when clearly needed
- 2-4 steps maximum
- Output ONLY a valid JSON array`},{role:"user",content:t}]),a=new Promise(p=>setTimeout(()=>p(null),2e4)),u=await Promise.race([e,a]);if(!u)return console.log("[AgentLens] LLM plan generation timed out, using fallback"),L(t);const d=u.content?.trim()||"";console.log("[AgentLens] LLM plan response:",d.slice(0,200));const i=d.match(/\[[\s\S]*\]/);if(i)return JSON.parse(i[0]).map((r,f)=>{const g=x[r.tool];return{id:f+1,title:r.title||`Step ${f+1}`,description:r.description||"",tool:g?r.tool:"read_page",toolParams:r.toolParams||{},requiredPermission:g?.requiredPermission||"page_read",status:"pending",isWriteAction:g?.isWriteAction||!1,tokens:0}});console.log("[AgentLens] Could not parse LLM plan JSON, using fallback")}catch(e){console.error("[AgentLens] generatePlan error:",e)}return L(t)}function G(){return new Promise(t=>{chrome.tabs.query({active:!0,currentWindow:!0},n=>{t(n?.[0]||null)})})}function _(t,n){return typeof E<"u"&&E.tabs?.sendMessage?E.tabs.sendMessage(t,n):_(t,n)}async function ae(t,n){if(!l||t>=l.steps.length)return null;const e=l.steps[t];e.status="running",console.log("[AgentLens] executeStep",t,e.tool,"tabId:",n);const a=o.provider==="ollama",u=a?"local":"cloud";let d="unknown";try{l.pageContext?.url&&(d=new URL(l.pageContext.url).hostname)}catch{}const i=e.requiredPermission||"page_read";if(!await b(n,i,d,`Step "${e.title}": ${e.description}`,e.isWriteAction?"medium":"low"))return e.status="skipped",e.llmOutput="(Permission denied by user)",e;if(!a&&!await b(n,"data_send",d,`Send page content to ${o.provider} for analysis`,"high"))return e.status="skipped",e.llmOutput="(Cloud send denied â€” switch to local Ollama for no-cloud processing)",e;try{let r=null;switch(e.tool){case"read_page":case"extract_data":{r=await _(n,{type:"READ_PAGE",maxTokens:2e3});break}case"find_on_page":{r=await _(n,{type:"FIND_ON_PAGE",query:e.toolParams?.query||e.description});break}case"click_element":{r=await _(n,{type:"CLICK_ELEMENT",selector:e.toolParams?.selector||""});break}case"fill_form":{let m=e.toolParams?.fields||{};if(typeof m=="string")try{m=JSON.parse(m)}catch{m={}}r=await _(n,{type:"FILL_FORM",fields:m});break}case"navigate":{const m=e.toolParams?.url;m?(await chrome.tabs.create({url:m}),r={success:!0,navigated:m}):r={success:!1,error:"No URL provided"};break}default:r={success:!1,error:`Unknown tool: ${e.tool}`}}if(console.log("[AgentLens] Tool result:",e.tool,r?.success),!r?.success)return e.status="completed",e.result=r,e.llmOutput=`(Tool error: ${r?.error||"unknown"})`,e;const f=r.context||r.matches||r,g=Math.ceil(JSON.stringify(f).length/4),y=r.context?.structuredData?.emailCount>0?"medium":"low";if(O({origin:d,originType:"page_content",dataType:e.tool,tokenCount:g,sensitivity:y,entryMethod:"tool_call"}),h({type:"tool_call",origin:d,detail:{tool:e.tool,params:e.toolParams},tokensInvolved:g,processingLocation:u}),s.processingLocation=u,A(),e.result=f,e.tokens=g,e.origin=d,e.sensitivity=y,o.model)try{const m=l.steps.filter(P=>P.status==="completed"&&P.llmOutput).map(P=>`${P.title}: ${P.llmOutput}`),v=e.tool==="read_page"||e.tool==="extract_data"?r.summary||JSON.stringify(f).slice(0,3e3):JSON.stringify(f).slice(0,1e3),q=m.length>0?`
Previous steps:
${m.join(`
`)}`:"",T=`Task: "${l.intent}"
Step: ${e.title}
Tool: ${e.tool}

Page data:
${v}${q}

Provide a helpful, concise response (3-4 sentences). Answer the user's question directly.`;console.log("[AgentLens] Calling LLM for analysis...");const F=await c([{role:"system",content:"You are a helpful AI assistant analyzing real browser page content. Be concise and specific."},{role:"user",content:T}]);e.llmOutput=F.content||"(No response)",console.log("[AgentLens] LLM response received, length:",e.llmOutput.length);const W=Math.ceil((T.length+e.llmOutput.length)/4);h({type:"llm_prompt",origin:"agentlens",detail:{step:e.title,provider:o.provider},tokensInvolved:W,processingLocation:F.processingLocation}),s.contextUsed+=W}catch(m){console.error("[AgentLens] LLM error:",m),e.llmOutput="(LLM unavailable â€” showing raw data)"}else e.llmOutput="(No model configured â€” showing raw data)";e.status="completed"}catch(r){console.error("[AgentLens] Step execution error:",r),e.status="completed",e.result={error:String(r)},e.llmOutput=`(Error: ${String(r)})`}return s.processingLocation="idle",h({type:"task_step",origin:d,detail:{step:e.title,tool:e.tool},processingLocation:u}),A(),e}function ie(t){if(!l)return null;const n=new Set(l.steps.filter(a=>a.status==="completed"&&a.origin).map(a=>a.origin).filter(Boolean)),e=l.pageContext?.url?new URL(l.pageContext.url).hostname:null;if(!e||n.size===0)return null;if(!n.has(e)){const a=[...n,e],u=l.steps.some(i=>i.status==="completed"&&i.sensitivity==="high"),d=o.provider!=="ollama"?` All this data is being sent to ${o.provider} cloud servers.`:" Processing is local â€” data stays on device.";return u?`Data from ${a.join(" + ")} is merging in the AI context. This includes sensitive data.${d}`:`Data from ${a.join(" + ")} is merging in the AI context.${d}`}return null}async function J(){const t={financial:"ðŸ’°",schedule:"ðŸ“…",preferences:"ðŸŽ§",relationships:"ðŸ‘¤",habits:"ðŸ“",work:"ðŸ¢",location:"ðŸ“",health:"â¤ï¸"};let e=[{inference:"Browsing activity tracked",confidence:"high",derivedFrom:["Page content was read during task"],category:"habits",icon:"ðŸ“"}];if(o.model&&s.auditEvents.length>0)try{const d=s.auditEvents,i=s.dataEntries,p=`Given the following AI session activity, list personal attributes, preferences, habits, or behaviors that can be INFERRED about the user.

For each inference, output a JSON object with:
- "inference": specific inference (string)
- "confidence": "high", "medium", or "low"
- "derivedFrom": array of strings explaining what data led to this
- "category": one of "financial", "schedule", "preferences", "relationships", "habits", "work"

Output ONLY a JSON array, no other text.

Session activity:
${JSON.stringify(d.map(y=>({type:y.type,origin:y.origin,detail:y.detail})))}

Data collected:
${JSON.stringify(i.map(y=>({origin:y.origin,dataType:y.dataType,sensitivity:y.sensitivity,tokens:y.tokenCount})))}`,g=((await c([{role:"system",content:"You are analyzing what an AI system can INFER about a user from their browsing activity. Output ONLY a valid JSON array."},{role:"user",content:p}])).content?.trim()||"").match(/\[[\s\S]*\]/);g&&(e=JSON.parse(g[0]).map(m=>({inference:m.inference||"",confidence:m.confidence||"medium",derivedFrom:m.derivedFrom||[],category:m.category||"preferences",icon:t[m.category]||"ðŸ”"})))}catch{}const a=Date.now(),u={shadowProfile:{inferences:e.map(d=>({...d,timestamp:a,sessionId:s.sessionId})),firstSeen:a,lastUpdated:a,sessionCount:1}};return console.log("[AgentLens] Saving shadow profile:",u.shadowProfile.inferences.length,"inferences"),new Promise(d=>{chrome.storage.local.set(u,()=>d())})}let w={running:!1,calls:[],finalAnswer:"",error:null};async function ce(t,n,e){o.provider;const a=x[t];if(a){let i="unknown";try{const r=await new Promise(f=>{chrome.tabs.get(e,g=>f(g||null))});r?.url&&(i=new URL(r.url).hostname)}catch{}if(!await b(e,a.requiredPermission,i,`Tool "${t}": ${a.description}`,a.isWriteAction?"medium":"low"))return{success:!1,error:"Permission denied"};switch(t){case"read_page":case"extract_data":return _(e,{type:"READ_PAGE",maxTokens:n.max_tokens||2e3});case"find_on_page":return _(e,{type:"FIND_ON_PAGE",query:n.query||""});case"click_element":return _(e,{type:"CLICK_ELEMENT",selector:n.selector||""});case"fill_form":{let r=n.fields||{};if(typeof r=="string")try{r=JSON.parse(r)}catch{}return _(e,{type:"FILL_FORM",fields:r})}case"navigate":return n.url?(await chrome.tabs.create({url:n.url}),{success:!0,navigated:n.url}):{success:!1,error:"No URL provided"};default:return{success:!1,error:`Unknown built-in tool: ${t}`}}}const d=(await U()).find(i=>i.id===t);if(d){if(d.type==="page_script"){let i="unknown";try{const f=await new Promise(g=>{chrome.tabs.get(e,y=>g(y||null))});f?.url&&(i=new URL(f.url).hostname)}catch{}if(!await b(e,"page_action",i,`Custom tool "${d.name}"`,"medium"))return{success:!1,error:"Permission denied"};let r=d.script||"";for(const[f,g]of Object.entries(n))r=r.replace(new RegExp(`\\{${f}\\}`,"g"),String(g));return _(e,{type:"EXEC_CUSTOM_SCRIPT",script:r})}if(d.type==="fetch_url"){let i=d.url||"";for(const[p,r]of Object.entries(n))i=i.replace(new RegExp(`\\{${p}\\}`,"g"),encodeURIComponent(String(r)));try{const p=await fetch(i);return{success:!0,data:(await p.text()).slice(0,3e3),status:p.status}}catch(p){return{success:!1,error:String(p)}}}}return{success:!1,error:`Unknown tool: ${t}`}}async function le(t,n){w={running:!0,calls:[],finalAnswer:"",error:null};const u=o.provider==="ollama"?"local":"cloud",d=await U(),i=Z(d),p=[{role:"system",content:"You are a helpful browser AI assistant. You have access to tools that can read the current web page, search for text, extract data, and more. Use tools when needed to answer the user's question. Be concise."},{role:"user",content:t}];k();for(let r=0;r<5;r++)try{console.log(`[AgentLens] Tool loop iteration ${r+1}/5`);const f=await c(p,{tools:i});if(f.toolCalls&&f.toolCalls.length>0)for(const g of f.toolCalls){const y=g.function?.name||"",m=g.function?.arguments||{};console.log(`[AgentLens] Tool call: ${y}`,m),h({type:"tool_call_start",origin:"agentlens",detail:{tool:y,args:m,iteration:r+1},processingLocation:u});const v=await ce(y,m,n),q={toolName:y,args:m,result:typeof v=="object"?JSON.stringify(v).slice(0,500):String(v),iteration:r+1,timestamp:Date.now()};w.calls.push(q);const T=Math.ceil(JSON.stringify(v).length/4);O({origin:"agentlens",originType:"local",dataType:`tool:${y}`,tokenCount:T,sensitivity:"low",entryMethod:"tool_call"}),h({type:"tool_call_result",origin:"agentlens",detail:{tool:y,success:v?.success},tokensInvolved:T,processingLocation:u}),p.push({role:"assistant",content:""}),p.push({role:"tool",content:JSON.stringify(v).slice(0,3e3)}),k()}else{w.finalAnswer=f.content,w.running=!1;const g=Math.ceil(f.content.length/4);h({type:"llm_prompt",origin:"agentlens",detail:{mode:"tool_call",iterations:r+1},tokensInvolved:g,processingLocation:u}),k(),console.log(`[AgentLens] Tool loop complete after ${r+1} iterations`);return}}catch(f){console.error("[AgentLens] Tool loop error:",f),w.error=String(f),w.running=!1,k();return}w.finalAnswer="(Reached maximum tool call iterations)",w.running=!1,k()}function k(){const t={type:"TOOL_CALL_UPDATE",state:{running:w.running,callCount:w.calls.length,calls:w.calls,finalAnswer:w.finalAnswer,error:w.error}};chrome.tabs.query({},n=>{for(const e of n)e.id&&_(e.id,t).catch(()=>{})})}const ue=(t,n)=>{try{if(t.type==="CREATE_PLAN"){console.log("[AgentLens] CREATE_PLAN, intent:",t.intent,"tabId:",t.tabId);const e=t.intent||"Analyze this page";return s.totalTokens=0,s.contextUsed=0,s.dataEntries=[],s.auditEvents=[],s.insights=[],s.sessionId=`sess_${Date.now()}`,h({type:"task_started",origin:"agentlens",detail:{intent:e,provider:o.provider,model:o.model},processingLocation:o.provider==="ollama"?"local":"cloud"}),(async()=>{try{let a={title:"Unknown",url:"",pageType:"generic",tokenEstimate:0};const u=t.tabId;if(u)try{const i=new Promise(f=>setTimeout(()=>f(null),2e3)),p=_(u,{type:"READ_PAGE",maxTokens:500}).catch(()=>null),r=await Promise.race([p,i]);console.log("[AgentLens] Page read:",r?.success??"timeout"),r?.success&&(a={title:r.context?.title||"Unknown",url:r.context?.url||"",pageType:r.context?.pageType||"generic",tokenEstimate:r.context?.tokenEstimate||0})}catch{}const d=await se(e);return l={intent:e,steps:d,status:"running",pageContext:a},console.log("[AgentLens] Plan created:",d.length,"steps, page:",a.title),{plan:l}}catch(a){console.error("[AgentLens] CREATE_PLAN fatal error:",a);const u=L(e);return l={intent:e,steps:u,status:"running"},{plan:l}}})()}if(t.type==="EXECUTE_STEP")return console.log("[AgentLens] EXECUTE_STEP",t.stepIdx,"tabId:",t.tabId),(async()=>{try{let e=t.tabId;return e||(e=(await G())?.id),e?{step:await ae(t.stepIdx,e)}:{step:null,error:"No active tab found"}}catch(e){return console.error("[AgentLens] EXECUTE_STEP error:",e),{step:null,error:String(e)}}})();if(t.type==="CHECK_CROSS_ORIGIN")return Promise.resolve({warning:ie(t.stepIdx)});if(t.type==="GENERATE_SHADOW_PROFILE")return J().then(()=>({ok:!0})).catch(()=>({ok:!1}));if(t.type==="GET_SESSION_STATE")return Promise.resolve({state:s});if(t.type==="GET_PERMISSIONS")return H(t.tabId).then(e=>({permissions:e})).catch(()=>({permissions:[]}));if(t.type==="CHECK_OLLAMA"){const e=t.endpoint||"http://localhost:11434";return fetch(`${e}/api/tags`).then(a=>({running:a.ok})).catch(()=>({running:!1}))}if(t.type==="LIST_OLLAMA_MODELS"){const e=t.endpoint||"http://localhost:11434";return fetch(`${e}/api/tags`).then(a=>a.json()).then(a=>({models:a.models||[]})).catch(()=>({models:[]}))}if(t.type==="TOOL_CALL_TASK")return console.log("[AgentLens] TOOL_CALL_TASK, intent:",t.intent),(async()=>{try{let e=t.tabId;return e||(e=(await G())?.id),e?(s.totalTokens=0,s.contextUsed=0,s.dataEntries=[],s.auditEvents=[],s.insights=[],s.sessionId=`sess_${Date.now()}`,h({type:"task_started",origin:"agentlens",detail:{intent:t.intent,mode:"tool_call",provider:o.provider},processingLocation:o.provider==="ollama"?"local":"cloud"}),await le(t.intent,e),await J(),{state:w}):{error:"No active tab found"}}catch(e){return{error:String(e)}}})();if(t.type==="GET_TOOL_CALL_STATE")return Promise.resolve({state:w});if(t.type==="GET_CUSTOM_TOOLS")return U().then(e=>({tools:e}));if(t.type==="SAVE_CUSTOM_TOOL")return ee(t.tool).then(()=>({ok:!0}));if(t.type==="DELETE_CUSTOM_TOOL")return te(t.toolId).then(()=>({ok:!0}));if(t.type==="OPEN_SIDEPANEL"){try{chrome.sidePanel?.open?n.tab?.windowId?chrome.sidePanel.open({windowId:n.tab.windowId}):chrome.windows.getCurrent(e=>{e.id&&chrome.sidePanel.open({windowId:e.id})}):E.sidebarAction?.open&&E.sidebarAction.open()}catch{}return Promise.resolve({ok:!0})}}catch(e){return console.error("[AgentLens] Message handler top-level error:",e),Promise.resolve({error:String(e)})}};chrome.runtime.onMessage.addListener(ue),console.log("[AgentLens] Background service worker started")});function pe(){}function C(o,...c){}const oe={debug:(...o)=>C(console.debug,...o),log:(...o)=>C(console.log,...o),warn:(...o)=>C(console.warn,...o),error:(...o)=>C(console.error,...o)};let D;try{D=ne.main(),D instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(o){throw oe.error("The background crashed on startup!"),o}var re=D;return re})();
