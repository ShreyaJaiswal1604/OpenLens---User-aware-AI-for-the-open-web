import{r as i,b as L,j as e,R as $,a as q}from"./global-BmMTH68k.js";function J(){const[t,n]=i.useState("loading"),[c,b]=i.useState(""),[a,x]=i.useState(null),[g,y]=i.useState(-1),[O,w]=i.useState(null),[h,S]=i.useState(null),[R,m]=i.useState(null),[f,C]=i.useState(null),[u,_]=i.useState("tool"),[o,N]=i.useState(null),P=i.useRef(null);i.useEffect(()=>{chrome.storage.local.get("setupConfig",s=>{s.setupConfig?.setupComplete?n("idle"):n("needs-setup")});const r=s=>{s.type==="TOOL_CALL_UPDATE"&&(N(s.state),!s.state.running&&(s.state.finalAnswer||s.state.error)&&n("completed"))};return chrome.runtime.onMessage.addListener(r),()=>chrome.runtime.onMessage.removeListener(r)},[]);const j=typeof L<"u"?L.runtime.sendMessage.bind(L.runtime):chrome.runtime.sendMessage.bind(chrome.runtime);async function k(){return new Promise(r=>{chrome.tabs.query({active:!0,currentWindow:!0},s=>{r(s[0]?.id||null)})})}async function W(){const r=c||"What are the key details on this page?";m(null),n("planning");try{const s=await k();C(s),console.log("[AgentLens Sidebar] Starting task, tabId:",s);const l=await j({type:"CREATE_PLAN",intent:r,tabId:s});console.log("[AgentLens Sidebar] CREATE_PLAN response:",JSON.stringify(l)),l?.plan?(x(l.plan),n("running"),y(0),v(l.plan,0,s)):(m(`No plan in response: ${JSON.stringify(l).slice(0,200)}`),n("idle"))}catch(s){console.error("[AgentLens Sidebar] startTask error:",s),m(`Error: ${String(s)}`),n("idle")}}async function D(){const r=c||"What are the key details on this page?";m(null),n("running"),N({running:!0,callCount:0,calls:[],finalAnswer:"",error:null});try{const s=await k();C(s),console.log("[AgentLens Sidebar] Starting tool task, tabId:",s);const l=await j({type:"TOOL_CALL_TASK",intent:r,tabId:s});l?.state&&N(l.state),l?.error&&m(l.error),n("completed")}catch(s){console.error("[AgentLens Sidebar] startToolTask error:",s),m(`Error: ${String(s)}`),n("completed")}}async function v(r,s,l){if(s>=r.steps.length){n("completed"),j({type:"GENERATE_SHADOW_PROFILE"}).catch(()=>{});return}const p=r.steps[s];try{const d=await j({type:"CHECK_CROSS_ORIGIN",stepIdx:s});if(d?.warning){w(d.warning);return}}catch{}if(p.isWriteAction){S(p);return}await A(r,s,l)}async function A(r,s,l){const p=l||f||await k();try{console.log("[AgentLens Sidebar] EXECUTE_STEP",s,"tabId:",p);const d=await j({type:"EXECUTE_STEP",stepIdx:s,tabId:p});if(console.log("[AgentLens Sidebar] EXECUTE_STEP response:",d?.step?.status),d?.step){const E={...r};E.steps[s]=d.step,x({...E}),y(s+1),setTimeout(()=>{P.current?.lastElementChild?.scrollIntoView({behavior:"smooth"})},100),setTimeout(()=>v(E,s+1,p),800)}else m(d?.error||"Step failed"),y(s+1),setTimeout(()=>v(r,s+1,p),500)}catch(d){console.error("[AgentLens Sidebar] executeCurrentStep error:",d),m(`Step error: ${String(d)}`),n("completed")}}function M(r){if(w(null),r==="stop"){n("completed");return}a&&A(a,g,f)}function I(r){if(S(null),r==="skip"){a&&(a.steps[g].status="skipped",x({...a}),y(g+1),v(a,g+1,f));return}a&&A(a,g,f)}function T(){n("idle"),x(null),y(-1),w(null),S(null),b(""),m(null),C(null),N(null)}return t==="loading"?e.jsx("div",{className:"min-h-screen bg-gray-950 text-white flex items-center justify-center",children:e.jsx("div",{className:"text-lg animate-pulse",children:"Loading..."})}):t==="needs-setup"?e.jsxs("div",{className:"min-h-screen bg-gray-950 text-white flex flex-col items-center justify-center p-8 gap-4",children:[e.jsx("div",{className:"text-4xl",children:"âš™ï¸"}),e.jsx("h2",{className:"text-lg font-semibold",children:"Setup Required"}),e.jsx("p",{className:"text-sm text-gray-400 text-center",children:"Open the AgentLens popup to configure your hardware and select an AI model before using the Agent Panel."}),e.jsx("button",{onClick:()=>{chrome.storage.local.get("setupConfig",r=>{r.setupConfig?.setupComplete&&n("idle")})},className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium",children:"Refresh"})]}):e.jsxs("div",{className:"min-h-screen bg-gray-950 text-white",children:[e.jsxs("div",{className:"px-4 py-3 border-b border-gray-800 flex items-center justify-between",children:[e.jsxs("h1",{className:"font-bold flex items-center gap-2",children:[e.jsx("span",{children:"ðŸ”"})," AgentLens â€” Transparent Agent"]}),t!=="idle"&&e.jsx("button",{onClick:T,className:"text-xs text-gray-500 hover:text-gray-300",children:"Reset"})]}),e.jsxs("div",{className:"p-4",children:[t==="idle"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex rounded-lg bg-gray-900 p-1",children:[e.jsxs("button",{onClick:()=>_("tool"),className:`flex-1 py-1.5 rounded text-sm font-medium transition-colors ${u==="tool"?"bg-blue-600 text-white":"text-gray-400 hover:text-white"}`,children:["ðŸ”§"," Tool Mode"]}),e.jsxs("button",{onClick:()=>_("plan"),className:`flex-1 py-1.5 rounded text-sm font-medium transition-colors ${u==="plan"?"bg-blue-600 text-white":"text-gray-400 hover:text-white"}`,children:["ðŸ“‹"," Plan Mode"]})]}),e.jsx("p",{className:"text-sm text-gray-400",children:u==="tool"?"LLM dynamically picks which tools to call (MCP-style). Tools are visible in the insights bar.":"Agent reads the page step-by-step with full transparency."}),e.jsx("textarea",{value:c,onChange:r=>b(r.target.value),placeholder:"What are the key details on this page?",className:"w-full h-24 bg-gray-900 border border-gray-700 rounded-lg p-3 text-sm resize-none focus:outline-none focus:border-blue-500"}),e.jsxs("button",{onClick:u==="tool"?D:W,className:"w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium",children:["ðŸš€"," Start Task"]}),e.jsxs("div",{className:"bg-gray-900/50 rounded-lg p-3 text-xs text-gray-500 space-y-1",children:[e.jsx("strong",{children:u==="tool"?"Tool Mode:":"Plan Mode:"}),e.jsx("ul",{className:"list-disc pl-4 space-y-0.5",children:u==="tool"?e.jsxs(e.Fragment,{children:[e.jsx("li",{children:"LLM decides which tools to use automatically"}),e.jsx("li",{children:"Tools: read page, search, extract data, and custom tools"}),e.jsx("li",{children:"Each tool call shown transparently"}),e.jsxs("li",{children:["Configure custom tools in the popup ","â†’"," Tools tab"]})]}):e.jsxs(e.Fragment,{children:[e.jsx("li",{children:"Agent reads the current page (with your permission)"}),e.jsx("li",{children:"Each step shows what data is accessed and why"}),e.jsx("li",{children:"Write actions require explicit approval"}),e.jsx("li",{children:"Cloud sends need separate consent"})]})})]})]}),t==="planning"&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-4",children:[e.jsx("div",{className:"text-3xl animate-pulse",children:"ðŸ§ "}),e.jsx("div",{className:"text-sm text-gray-400",children:"Reading page & planning steps..."})]}),(t==="running"||t==="completed")&&u==="tool"&&o&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-900 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Task (Tool Mode)"}),e.jsx("div",{className:"text-sm",children:c||"Analyzing page..."})]}),o.calls.map((r,s)=>e.jsx(U,{call:r},s)),o.running&&e.jsxs("div",{className:"flex items-center gap-3 py-4 justify-center",children:[e.jsx("div",{className:"text-xl animate-spin",children:"ðŸ”„"}),e.jsxs("span",{className:"text-sm text-gray-400",children:["LLM thinking... (",o.callCount," tool",o.callCount!==1?"s":""," called)"]})]}),o.finalAnswer&&e.jsxs("div",{className:"bg-blue-900/20 border border-blue-700 rounded-lg p-4",children:[e.jsx("div",{className:"text-xs text-blue-400 mb-2 font-semibold",children:"Final Answer"}),e.jsx("div",{className:"text-sm whitespace-pre-wrap",children:o.finalAnswer})]}),o.error&&e.jsx("div",{className:"bg-red-900/20 border border-red-700 rounded-lg p-3 text-sm text-red-300",children:o.error}),t==="completed"&&e.jsxs("div",{className:"bg-green-900/20 border border-green-700 rounded-lg p-4 text-center space-y-2",children:[e.jsx("div",{className:"text-2xl",children:"âœ…"}),e.jsx("div",{className:"font-semibold text-green-300",children:"Task Complete"}),e.jsxs("p",{className:"text-sm text-gray-400",children:[o.callCount," tool call",o.callCount!==1?"s":""," made. Check the Shadow Profile to see what your AI inferred."]}),e.jsx("button",{onClick:T,className:"mt-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm",children:"Run Another Task"})]})]}),(t==="running"||t==="completed")&&u==="plan"&&a&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-900 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Task"}),e.jsx("div",{className:"text-sm",children:a.intent}),a.pageContext&&a.pageContext.title!=="Unknown"&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-gray-800 flex items-center gap-2 text-xs text-gray-500",children:[e.jsx("span",{children:"ðŸ“„"}),e.jsx("span",{className:"truncate",children:a.pageContext.title}),e.jsx("span",{className:"ml-auto shrink-0 px-1.5 py-0.5 rounded bg-gray-800 text-gray-400",children:a.pageContext.pageType}),e.jsxs("span",{className:"shrink-0 text-gray-600",children:["~",a.pageContext.tokenEstimate," tokens"]})]})]}),e.jsx("div",{ref:P,className:"space-y-3",children:a.steps.map((r,s)=>e.jsx(F,{step:r,isActive:s===g&&t==="running"},r.id))}),O&&e.jsxs("div",{className:"bg-yellow-900/30 border border-yellow-600 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 font-semibold text-yellow-300",children:[e.jsx("span",{children:"âš ï¸"})," Cross-Origin Data Merge"]}),e.jsx("p",{className:"text-sm text-yellow-200",children:O}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>M("allow"),className:"flex-1 py-2 bg-yellow-600 hover:bg-yellow-700 rounded text-sm font-medium",children:"Allow & Continue"}),e.jsx("button",{onClick:()=>M("stop"),className:"flex-1 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm",children:"Stop Task"})]})]}),h&&e.jsxs("div",{className:"bg-red-900/20 border border-red-600/50 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 font-semibold text-red-300",children:[e.jsx("span",{children:"âœï¸"})," Write Action â€” Approval Required"]}),e.jsx("p",{className:"text-sm text-gray-300",children:h.description}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Tool: ",e.jsx("span",{className:"text-gray-400",children:h.tool}),h.toolParams&&Object.keys(h.toolParams).length>0&&e.jsxs("span",{children:[" | Params: ",JSON.stringify(h.toolParams)]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>I("approve"),className:"flex-1 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm font-medium",children:"Approve"}),e.jsx("button",{onClick:()=>I("skip"),className:"flex-1 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm",children:"Skip"})]})]}),t==="completed"&&e.jsxs("div",{className:"bg-green-900/20 border border-green-700 rounded-lg p-4 text-center space-y-2",children:[e.jsx("div",{className:"text-2xl",children:"âœ…"}),e.jsx("div",{className:"font-semibold text-green-300",children:"Task Complete"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Check the Shadow Profile to see what your AI inferred about you."}),e.jsx("button",{onClick:T,className:"mt-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm",children:"Run Another Task"})]})]}),R&&e.jsx("div",{className:"mt-4 bg-red-900/20 border border-red-700 rounded-lg p-3 text-sm text-red-300",children:R})]})]})}function U({call:t}){const[n,c]=i.useState(!1),a={read_page:"ðŸ“–",extract_data:"ðŸ“Š",find_on_page:"ðŸ”Ž",navigate:"ðŸ”—",fill_form:"âœï¸",click_element:"ðŸŽ¯"}[t.toolName]||"ðŸ”§",x=typeof t.args=="object"?JSON.stringify(t.args):String(t.args),g=new Date(t.timestamp).toLocaleTimeString();return e.jsxs("div",{className:"rounded-lg border border-gray-700 bg-gray-900 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{children:a}),e.jsx("span",{className:"font-medium text-sm",children:t.toolName}),e.jsxs("span",{className:"ml-auto text-xs text-gray-500",children:["#",t.iteration," ",g]})]}),x!=="{}"&&e.jsx("div",{className:"text-xs text-gray-400 ml-6 truncate",children:x.slice(0,100)}),e.jsx("div",{className:"mt-1 ml-6",children:e.jsx("button",{onClick:()=>c(!n),className:"text-xs text-blue-400 hover:text-blue-300",children:n?"Hide result":"Show result"})}),n&&e.jsx("div",{className:"mt-2 ml-6 bg-gray-800/50 border border-gray-700 rounded p-2.5 text-xs text-gray-300 max-h-40 overflow-y-auto",children:e.jsx("pre",{className:"whitespace-pre-wrap break-all",children:typeof t.result=="string"?t.result.slice(0,800):JSON.stringify(t.result,null,2).slice(0,800)})})]})}function F({step:t,isActive:n}){const[c,b]=i.useState(!1),a={pending:"â³",running:"ðŸ”„",awaiting_approval:"âœ‹",completed:"âœ…",skipped:"â­ï¸"}[t.status],x={page_read:"ðŸ“–",page_action:"ðŸŽ¯",data_send:"â˜ï¸"}[t.requiredPermission]||"ðŸ”’";return e.jsxs("div",{className:`rounded-lg border p-3 transition-all ${n?"border-blue-500 bg-blue-900/20":t.status==="completed"?"border-green-800 bg-gray-900":t.status==="skipped"?"border-gray-700 bg-gray-900/50 opacity-60":"border-gray-800 bg-gray-900"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:n?"animate-spin":"",children:a}),e.jsx("span",{className:"font-medium text-sm",children:t.title}),e.jsxs("span",{className:"ml-auto flex items-center gap-1.5",children:[t.isWriteAction&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-red-900/40 text-red-400 font-semibold",children:"WRITE"}),e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-800 text-gray-500",title:`Permission: ${t.requiredPermission}`,children:[x," ",t.tool]}),t.tokens>0&&e.jsxs("span",{className:"text-xs text-gray-500",children:[t.tokens," tk"]})]})]}),e.jsx("p",{className:"text-xs text-gray-400 ml-6",children:t.description}),t.llmOutput&&e.jsx("div",{className:"mt-2 ml-6 bg-gray-800 rounded p-2.5 text-sm",children:t.llmOutput}),t.result&&t.status==="completed"&&e.jsxs("div",{className:"mt-2 ml-6 flex gap-2",children:[t.llmOutput&&e.jsx("button",{onClick:()=>b(!c),className:"text-xs text-blue-400 hover:text-blue-300",children:c?"Hide data":"Show data used"}),t.origin&&e.jsxs("span",{className:"text-xs text-gray-600",children:["from ",t.origin]})]}),c&&t.result&&e.jsxs("div",{className:"mt-2 ml-6 bg-gray-800/50 border border-gray-700 rounded p-2.5 text-xs text-gray-300 max-h-40 overflow-y-auto",children:[e.jsx("strong",{children:"Raw data:"}),e.jsx("pre",{className:"mt-1 whitespace-pre-wrap break-all",children:JSON.stringify(t.result,null,2).slice(0,1e3)})]})]})}$.createRoot(document.getElementById("root")).render(e.jsx(q.StrictMode,{children:e.jsx(J,{})}));
