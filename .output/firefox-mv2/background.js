var background=(function(){"use strict";function Z(o){return o==null||typeof o=="function"?{main:o}:o}const M=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome,J="permissions";function N(){return new Promise(o=>{chrome.storage.local.get(J,i=>{o(i?.[J]||[])})})}function q(o){return new Promise(i=>{chrome.storage.local.set({[J]:o},()=>i())})}async function ee(o,i,l){const s=await N(),v=Date.now();return s.find(f=>{if(f.type!==o||f.expiresAt&&f.expiresAt<v)return!1;switch(f.scope){case"page":return f.tabId===l&&f.origin===i;case"site":return f.origin===i;case"session":return!0}})||null}async function U(o,i,l,s){const v=await N(),f=Date.now(),w={type:o,scope:i,origin:l,tabId:s,grantedAt:f,expiresAt:i==="page"?null:f+1800*1e3},E=v.filter(A=>!(A.type===o&&A.origin===l&&A.tabId===s));return E.push(w),await q(E),w}async function te(o){const l=(await N()).filter(s=>s.tabId!==o);await q(l)}async function oe(o){const l=(await N()).filter(s=>!(s.scope==="page"&&s.tabId===o));await q(l)}async function ne(o){const i=await N(),l=Date.now();return i.filter(s=>!(s.expiresAt&&s.expiresAt<l||o!==void 0&&s.tabId!==o))}const R={read_page:{name:"read_page",description:"Extract and summarize the current page content",requiredPermission:"page_read",isWriteAction:!1},extract_data:{name:"extract_data",description:"Extract structured data (prices, links, forms, headings) from the page",requiredPermission:"page_read",isWriteAction:!1},find_on_page:{name:"find_on_page",description:"Search for specific text on the page",requiredPermission:"page_read",isWriteAction:!1,params:{query:"Text to search for"}},navigate:{name:"navigate",description:"Open a URL in a new tab",requiredPermission:"page_action",isWriteAction:!0,params:{url:"URL to open"}},fill_form:{name:"fill_form",description:"Fill form fields (user must submit manually)",requiredPermission:"page_action",isWriteAction:!0,params:{fields:"Object of field name â†’ value pairs"}},click_element:{name:"click_element",description:"Click a link or button by selector or text",requiredPermission:"page_action",isWriteAction:!0,params:{selector:"CSS selector or text content to match"}}},se={read_page:{max_tokens:{type:"number",description:"Maximum tokens to extract (default 2000)"}},extract_data:{data_type:{type:"string",description:"Type of data to extract: prices, links, forms, or headings"}},find_on_page:{query:{type:"string",description:"Text to search for on the page"}},navigate:{url:{type:"string",description:"URL to open in a new tab"}},fill_form:{fields:{type:"string",description:"JSON object of field name to value pairs"}},click_element:{selector:{type:"string",description:"CSS selector or visible text of the element to click"}}};function re(){return Object.values(R).map(o=>{const i=se[o.name]||{},l=o.name==="find_on_page"?["query"]:o.name==="navigate"?["url"]:o.name==="click_element"?["selector"]:o.name==="fill_form"?["fields"]:[];return{type:"function",function:{name:o.name,description:o.description,parameters:{type:"object",properties:i,required:l}}}})}function ae(o){return o.map(i=>({type:"function",function:{name:i.name,description:`[${i.serverName}] ${i.description}`,parameters:{type:"object",properties:i.inputSchema.properties||{},required:i.inputSchema.required||[]}}}))}function ie(o){return[...re(),...ae(o)]}const G="mcpServers";function D(){return new Promise(o=>{chrome.storage.local.get(G,i=>{o(i?.[G]||[])})})}function K(o){return new Promise(i=>{chrome.storage.local.set({[G]:o},()=>i())})}async function F(){return D()}async function z(o){const i=await D(),l=i.findIndex(s=>s.id===o.id);l>=0?i[l]=o:i.push(o),await K(i)}async function le(o){const i=await D();await K(i.filter(l=>l.id!==o))}async function W(o){const i=await o.text(),l=i.match(/^data:\s*(.+)$/m);return JSON.parse(l?l[1]:i)}async function B(o){const i={"Content-Type":"application/json",Accept:"application/json, text/event-stream"},l=JSON.stringify({jsonrpc:"2.0",id:0,method:"initialize",params:{protocolVersion:"2024-11-05",capabilities:{},clientInfo:{name:"OpenLens",version:"1.0"}}}),s=[],v=o.replace(/\/$/,"")+"/mcp";try{console.log("[OpenLens MCP] Probing",v);const f=await fetch(v,{method:"POST",headers:i,body:l});if(console.log("[OpenLens MCP] Probe /mcp status:",f.status),f.ok)return v;s.push(`/mcp: HTTP ${f.status}`)}catch(f){console.log("[OpenLens MCP] Probe /mcp error:",f),s.push(`/mcp: ${f}`)}try{console.log("[OpenLens MCP] Probing",o);const f=await fetch(o,{method:"POST",headers:i,body:l});if(console.log("[OpenLens MCP] Probe / status:",f.status),f.ok)return o;s.push(`/: HTTP ${f.status}`)}catch(f){console.log("[OpenLens MCP] Probe / error:",f),s.push(`/: ${f}`)}throw new Error(`Could not find MCP endpoint at /mcp or / â€” ${s.join("; ")}`)}async function ce(o){const i={"Content-Type":"application/json",Accept:"application/json, text/event-stream"},l=await B(o);let s={name:"Unknown",version:"0"};try{const S=await fetch(l,{method:"POST",headers:i,body:JSON.stringify({jsonrpc:"2.0",id:1,method:"initialize",params:{}})});S.ok&&(s=(await W(S)).result?.serverInfo||s)}catch{}const v=`mcp_${s.name}_${Date.now()}`,f=await fetch(l,{method:"POST",headers:i,body:JSON.stringify({jsonrpc:"2.0",id:2,method:"tools/list"})});if(!f.ok)throw new Error(`tools/list failed: ${f.status}`);const A=((await W(f)).result?.tools||[]).map(S=>({name:S.name,description:S.description||"",serverId:v,serverName:s.name,inputSchema:S.inputSchema||{type:"object",properties:{},required:[]}}));return{serverInfo:s,tools:A,serverId:v}}async function pe(o,i,l){const s={"Content-Type":"application/json",Accept:"application/json, text/event-stream"};let v;try{v=await B(o)}catch{v=o}const f=await fetch(v,{method:"POST",headers:s,body:JSON.stringify({jsonrpc:"2.0",id:Date.now(),method:"tools/call",params:{name:i,arguments:l}})});if(!f.ok)throw new Error(`tools/call failed: ${f.status}`);const w=await W(f);if(w.result?.isError)throw new Error(w.result.content?.[0]?.text||"Tool call failed");return{success:!0,data:(w.result?.content||[]).map(S=>S.text||JSON.stringify(S)).join(`
`)}}async function H(){const o=await D(),i=[];for(const l of o)l.enabled&&l.tools&&i.push(...l.tools);return i}const ue=Z(()=>{let o={provider:"ollama",model:""};async function i(t,n){const{provider:e,model:a,apiKey:p,ollamaEndpoint:d}=o;switch(console.log("[OpenLens] llmChat called, provider:",e,"model:",a,"tools:",n?.tools?.length||0),e){case"ollama":{const g=d||"http://localhost:11434",u={model:a,messages:t,stream:!1};n?.tools?.length&&(u.tools=n.tools);let r=await fetch(`${g}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u)});if(!r.ok&&r.status===400&&n?.tools?.length){console.log("[OpenLens] Model does not support tool calling, falling back to prompt-based tools");const c=n.tools.map(O=>`- ${O.function.name}: ${O.function.description} (params: ${JSON.stringify(O.function.parameters.properties)})`).join(`
`),b=t.map(O=>{if(O.role==="system"){const I=O.content.includes("Current page content:")?`

You already have the page content above. Answer the user's question directly using that content. Do NOT call read_page â€” you already have it.

If you need OTHER tools (not read_page), respond with ONLY a JSON object like:
{"tool": "tool_name", "args": {"param": "value"}}

Available tools:
${c}

IMPORTANT: Answer directly using the page content provided above. Only use a tool JSON if you need something OTHER than page content.`:`

You have access to tools. To call a tool, you MUST respond with ONLY a JSON object like this:
{"tool": "tool_name", "args": {"param": "value"}}

Do NOT ask the user for information. Do NOT say you need data. Just call the appropriate tool.

Available tools:
${c}

IMPORTANT: If the user asks about a web page, call read_page first. Always respond with a tool call JSON when you need information.`;return{...O,content:O.content+I}}return O}),T={model:a,messages:b,stream:!1};if(r=await fetch(`${g}/api/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(T)}),!r.ok)throw new Error(`Ollama error: ${r.status}`);const k=(await r.json()).message?.content||"";try{const O=k.indexOf('{"tool"');if(O===-1)throw new Error("no tool json");let C=0,I=-1;for(let x=O;x<k.length;x++)if(k[x]==="{"&&C++,k[x]==="}"&&(C--,C===0)){I=x+1;break}if(I>O){const x=JSON.parse(k.slice(O,I));if(x.tool)return{content:"",processingLocation:"local",toolCalls:[{function:{name:x.tool,arguments:x.args||{}}}]}}}catch{}return{content:k,processingLocation:"local"}}if(!r.ok)throw new Error(`Ollama error: ${r.status}`);const _=await r.json(),m=_.message?.tool_calls;if(m?.length)return{content:_.message.content||"",processingLocation:"local",toolCalls:m};const h=_.message?.content||"";if(n?.tools?.length)try{const c=h.indexOf('{"tool"');if(c!==-1){let b=0,T=-1;for(let y=c;y<h.length;y++)if(h[y]==="{"&&b++,h[y]==="}"&&(b--,b===0)){T=y+1;break}if(T>c){const y=JSON.parse(h.slice(c,T));if(y.tool)return console.log("[OpenLens] Parsed tool-call JSON from plain text content:",y.tool),{content:"",processingLocation:"local",toolCalls:[{function:{name:y.tool,arguments:y.args||{}}}]}}}}catch{}return{content:h,processingLocation:"local"}}case"openai":{const g=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${p}`},body:JSON.stringify({model:a,messages:t,max_tokens:1024})});if(!g.ok)throw new Error(`OpenAI error: ${g.status}`);return{content:(await g.json()).choices?.[0]?.message?.content||"",processingLocation:"cloud"}}case"anthropic":{const g=t.find(m=>m.role==="system")?.content||"",u=t.filter(m=>m.role!=="system"),r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json","x-api-key":p,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify({model:a,max_tokens:1024,system:g,messages:u})});if(!r.ok)throw new Error(`Anthropic error: ${r.status}`);return{content:(await r.json()).content?.[0]?.text||"",processingLocation:"cloud"}}case"openrouter":{const g=await fetch("https://openrouter.ai/api/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${p}`,"HTTP-Referer":"https://openlens.dev","X-Title":"OpenLens"},body:JSON.stringify({model:a,messages:t,max_tokens:1024})});if(!g.ok)throw new Error(`OpenRouter error: ${g.status}`);return{content:(await g.json()).choices?.[0]?.message?.content||"",processingLocation:"cloud"}}default:throw new Error(`Unknown provider: ${e}`)}}let l=null,s={sessionId:`sess_${Date.now()}`,totalTokens:0,contextUsed:0,contextLimit:8192,selectedModel:"",provider:"ollama",processingLocation:"idle",dataEntries:[],auditEvents:[],insights:[],mcpToolCount:0};async function v(){const t=await H();s.mcpToolCount=t.length,E()}v(),chrome.storage.local.get("setupConfig",t=>{if(t.setupConfig){const n=t.setupConfig;s.selectedModel=n.selectedModel,s.provider=n.provider||"ollama",s.contextLimit=n.contextLength||8192,o={provider:n.provider||"ollama",model:n.selectedModel,apiKey:n.apiKey,ollamaEndpoint:n.ollamaEndpoint},console.log("[OpenLens] Config loaded:",o.provider,o.model)}}),chrome.storage.onChanged.addListener(t=>{if(t.setupConfig?.newValue){const n=t.setupConfig.newValue;s.selectedModel=n.selectedModel,s.provider=n.provider||"ollama",s.contextLimit=n.contextLength||8192,o={provider:n.provider||"ollama",model:n.selectedModel,apiKey:n.apiKey,ollamaEndpoint:n.ollamaEndpoint},console.log("[OpenLens] Config updated:",o.provider,o.model)}});function f(t){const n={...t,id:`de_${Date.now()}_${Math.random().toString(36).slice(2,6)}`,timestamp:Date.now()};s.dataEntries.push(n),s.totalTokens+=t.tokenCount||0,s.contextUsed+=t.tokenCount||0,E()}function w(t){const n={...t,id:`ae_${Date.now()}_${Math.random().toString(36).slice(2,6)}`,timestamp:Date.now()};s.auditEvents.push(n),E()}function E(){chrome.storage.local.set({sessionState:s}),chrome.tabs.query({},t=>{for(const n of t)n.id&&P(n.id,{type:"STATE_UPDATE",state:s}).catch(()=>{})})}chrome.tabs.onRemoved.addListener(t=>{te(t)}),chrome.tabs.onUpdated.addListener((t,n)=>{n.url&&oe(t)});async function A(t,n,e,a,p){if(await ee(n,e,t))return!0;const g=o.provider==="ollama",u=g?"local":"cloud";if(g&&n==="page_read")return await U(n,"session",e,t),w({type:"permission_granted",origin:e,detail:{permType:n,scope:"session",autoGranted:!0,reason:"Local processing â€” data stays on device"},userAction:"auto",processingLocation:u}),console.log("[OpenLens] Auto-granted page_read (local provider, no cloud risk)"),!0;w({type:"permission_requested",origin:e,detail:{permType:n,reason:a,sensitivity:p},processingLocation:u});try{const r=await P(t,{type:"SHOW_PERMISSION_DIALOG",permType:n,reason:a,sensitivity:p});return r?.granted?(await U(n,r.scope,e,t),w({type:"permission_granted",origin:e,detail:{permType:n,scope:r.scope},userAction:"approved",processingLocation:u}),!0):(w({type:"permission_denied",origin:e,detail:{permType:n},userAction:"denied",processingLocation:u}),!1)}catch(r){return console.error("[OpenLens] Permission dialog error:",r),g&&n==="page_action"?(await U(n,"page",e,t),w({type:"permission_granted",origin:e,detail:{permType:n,scope:"page",autoGranted:!0,reason:"Dialog unavailable, local provider"},processingLocation:u}),!0):!1}}function S(t){const n=t.toLowerCase(),e=[];e.push({id:1,title:"Read current page",description:"Extract and analyze the content of this page",tool:"read_page",requiredPermission:"page_read",status:"pending",isWriteAction:!1,tokens:0});const a=n.match(/find|search|look for|where is|show me|locate/),p=t.replace(/^.*?(find|search for|look for|where is|show me|locate)\s*/i,"").split(/[.,!?]/)[0].trim();return a&&p.length>2&&e.push({id:2,title:`Search for "${p.slice(0,40)}"`,description:`Find "${p}" on this page`,tool:"find_on_page",toolParams:{query:p},requiredPermission:"page_read",status:"pending",isWriteAction:!1,tokens:0}),e.push({id:e.length+1,title:"Analyze and respond",description:`Use page content to answer: "${t}"`,tool:"read_page",requiredPermission:"page_read",status:"pending",isWriteAction:!1,tokens:0}),e}async function V(t){if(!o.model)return console.log("[OpenLens] No model configured, using fallback plan"),S(t);const n=Object.values(R).map(e=>`- ${e.name}: ${e.description} (permission: ${e.requiredPermission}, write: ${e.isWriteAction})`).join(`
`);try{console.log("[OpenLens] Generating plan via LLM...");const e=i([{role:"system",content:`You are a browser agent planner. Given a user intent, create a plan using available tools.

Available tools:
${n}

Output a JSON array of steps, each with:
- "title": short action title
- "description": what this step does
- "tool": tool name from the list above
- "toolParams": optional params object (e.g. {"query": "text"} for find_on_page)

Rules:
- Always start with read_page or extract_data
- Use find_on_page for specific searches
- Only use write actions (navigate, fill_form, click_element) when clearly needed
- 2-4 steps maximum
- Output ONLY a valid JSON array`},{role:"user",content:t}]),a=new Promise(u=>setTimeout(()=>u(null),2e4)),p=await Promise.race([e,a]);if(!p)return console.log("[OpenLens] LLM plan generation timed out, using fallback"),S(t);const d=p.content?.trim()||"";console.log("[OpenLens] LLM plan response:",d.slice(0,200));const g=d.match(/\[[\s\S]*\]/);if(g)return JSON.parse(g[0]).map((r,_)=>{const m=R[r.tool];return{id:_+1,title:r.title||`Step ${_+1}`,description:r.description||"",tool:m?r.tool:"read_page",toolParams:r.toolParams||{},requiredPermission:m?.requiredPermission||"page_read",status:"pending",isWriteAction:m?.isWriteAction||!1,tokens:0}});console.log("[OpenLens] Could not parse LLM plan JSON, using fallback")}catch(e){console.error("[OpenLens] generatePlan error:",e)}return S(t)}function X(){return new Promise(t=>{chrome.tabs.query({active:!0,currentWindow:!0},n=>{t(n?.[0]||null)})})}function P(t,n){return typeof M<"u"&&M.tabs?.sendMessage?M.tabs.sendMessage(t,n):chrome.tabs.sendMessage(t,n)}async function me(t,n){if(!l||t>=l.steps.length)return null;const e=l.steps[t];e.status="running",console.log("[OpenLens] executeStep",t,e.tool,"tabId:",n);const a=o.provider==="ollama",p=a?"local":"cloud";let d="unknown";try{l.pageContext?.url&&(d=new URL(l.pageContext.url).hostname)}catch{}const g=e.requiredPermission||"page_read";if(!await A(n,g,d,`Step "${e.title}": ${e.description}`,e.isWriteAction?"medium":"low"))return e.status="skipped",e.llmOutput="(Permission denied by user)",e;if(!a&&!await A(n,"data_send",d,`Send page content to ${o.provider} for analysis`,"high"))return e.status="skipped",e.llmOutput="(Cloud send denied â€” switch to local Ollama for no-cloud processing)",e;try{let r=null;switch(e.tool){case"read_page":case"extract_data":{r=await P(n,{type:"READ_PAGE",maxTokens:2e3});break}case"find_on_page":{r=await P(n,{type:"FIND_ON_PAGE",query:e.toolParams?.query||e.description});break}case"click_element":{r=await P(n,{type:"CLICK_ELEMENT",selector:e.toolParams?.selector||""});break}case"fill_form":{let c=e.toolParams?.fields||{};if(typeof c=="string")try{c=JSON.parse(c)}catch{c={}}r=await P(n,{type:"FILL_FORM",fields:c});break}case"navigate":{const c=e.toolParams?.url;c?(await chrome.tabs.create({url:c}),r={success:!0,navigated:c}):r={success:!1,error:"No URL provided"};break}default:r={success:!1,error:`Unknown tool: ${e.tool}`}}if(console.log("[OpenLens] Tool result:",e.tool,r?.success),!r?.success)return e.status="completed",e.result=r,e.llmOutput=`(Tool error: ${r?.error||"unknown"})`,e;const _=r.context||r.matches||r,m=Math.ceil(JSON.stringify(_).length/4),h=r.context?.structuredData?.emailCount>0?"medium":"low";if(f({origin:d,originType:"page_content",dataType:e.tool,tokenCount:m,sensitivity:h,entryMethod:"tool_call"}),w({type:"tool_call",origin:d,detail:{tool:e.tool,params:e.toolParams},tokensInvolved:m,processingLocation:p}),s.processingLocation=p,E(),e.result=_,e.tokens=m,e.origin=d,e.sensitivity=h,o.model)try{const c=l.steps.filter(C=>C.status==="completed"&&C.llmOutput).map(C=>`${C.title}: ${C.llmOutput}`),b=e.tool==="read_page"||e.tool==="extract_data"?r.summary||JSON.stringify(_).slice(0,3e3):JSON.stringify(_).slice(0,1e3),T=c.length>0?`
Previous steps:
${c.join(`
`)}`:"",y=`Task: "${l.intent}"
Step: ${e.title}
Tool: ${e.tool}

Page data:
${b}${T}

Provide a helpful, concise response (3-4 sentences). Answer the user's question directly.`;console.log("[OpenLens] Calling LLM for analysis...");const k=await i([{role:"system",content:"You are a helpful AI assistant analyzing real browser page content. Be concise and specific."},{role:"user",content:y}]);e.llmOutput=k.content||"(No response)",console.log("[OpenLens] LLM response received, length:",e.llmOutput.length);const O=Math.ceil((y.length+e.llmOutput.length)/4);w({type:"llm_prompt",origin:"openlens",detail:{step:e.title,provider:o.provider},tokensInvolved:O,processingLocation:k.processingLocation}),s.contextUsed+=O}catch(c){console.error("[OpenLens] LLM error:",c),e.llmOutput="(LLM unavailable â€” showing raw data)"}else e.llmOutput="(No model configured â€” showing raw data)";e.status="completed"}catch(r){console.error("[OpenLens] Step execution error:",r),e.status="completed",e.result={error:String(r)},e.llmOutput=`(Error: ${String(r)})`}return s.processingLocation="idle",w({type:"task_step",origin:d,detail:{step:e.title,tool:e.tool},processingLocation:p}),E(),e}function ge(t){if(!l)return null;const n=new Set(l.steps.filter(a=>a.status==="completed"&&a.origin).map(a=>a.origin).filter(Boolean)),e=l.pageContext?.url?new URL(l.pageContext.url).hostname:null;if(!e||n.size===0)return null;if(!n.has(e)){const a=[...n,e],p=l.steps.some(g=>g.status==="completed"&&g.sensitivity==="high"),d=o.provider!=="ollama"?` All this data is being sent to ${o.provider} cloud servers.`:" Processing is local â€” data stays on device.";return p?`Data from ${a.join(" + ")} is merging in the AI context. This includes sensitive data.${d}`:`Data from ${a.join(" + ")} is merging in the AI context.${d}`}return null}async function Q(){const t={financial:"ðŸ’°",schedule:"ðŸ“…",preferences:"ðŸŽ§",relationships:"ðŸ‘¤",habits:"ðŸ“",work:"ðŸ¢",location:"ðŸ“",health:"â¤ï¸"};let e=[{inference:"Browsing activity tracked",confidence:"high",derivedFrom:["Page content was read during task"],category:"habits",icon:"ðŸ“"}];if(o.model&&s.auditEvents.length>0)try{const d=s.auditEvents,g=s.dataEntries,u=`Given the following AI session activity, list personal attributes, preferences, habits, or behaviors that can be INFERRED about the user.

For each inference, output a JSON object with:
- "inference": specific inference (string)
- "confidence": "high", "medium", or "low"
- "derivedFrom": array of strings explaining what data led to this
- "category": one of "financial", "schedule", "preferences", "relationships", "habits", "work"

Output ONLY a JSON array, no other text.

Session activity:
${JSON.stringify(d.map(h=>({type:h.type,origin:h.origin,detail:h.detail})))}

Data collected:
${JSON.stringify(g.map(h=>({origin:h.origin,dataType:h.dataType,sensitivity:h.sensitivity,tokens:h.tokenCount})))}`,m=((await i([{role:"system",content:"You are analyzing what an AI system can INFER about a user from their browsing activity. Output ONLY a valid JSON array."},{role:"user",content:u}])).content?.trim()||"").match(/\[[\s\S]*\]/);m&&(e=JSON.parse(m[0]).map(c=>({inference:c.inference||"",confidence:c.confidence||"medium",derivedFrom:c.derivedFrom||[],category:c.category||"preferences",icon:t[c.category]||"ðŸ”"})))}catch{}const a=Date.now(),p={shadowProfile:{inferences:e.map(d=>({...d,timestamp:a,sessionId:s.sessionId})),firstSeen:a,lastUpdated:a,sessionCount:1}};return console.log("[OpenLens] Saving shadow profile:",p.shadowProfile.inferences.length,"inferences"),new Promise(d=>{chrome.storage.local.set(p,()=>d())})}let L={running:!1,calls:[],finalAnswer:"",error:null};async function he(t,n,e){o.provider;const a=R[t];if(a){let d="unknown";try{const u=await new Promise(r=>{chrome.tabs.get(e,_=>r(_||null))});u?.url&&(d=new URL(u.url).hostname)}catch{}if(!await A(e,a.requiredPermission,d,`Tool "${t}": ${a.description}`,a.isWriteAction?"medium":"low"))return{success:!1,error:"Permission denied"};switch(t){case"read_page":case"extract_data":return P(e,{type:"READ_PAGE",maxTokens:n.max_tokens||2e3});case"find_on_page":return P(e,{type:"FIND_ON_PAGE",query:n.query||""});case"click_element":return P(e,{type:"CLICK_ELEMENT",selector:n.selector||""});case"fill_form":{let u=n.fields||{};if(typeof u=="string")try{u=JSON.parse(u)}catch{}return P(e,{type:"FILL_FORM",fields:u})}case"navigate":return n.url?(await chrome.tabs.create({url:n.url}),{success:!0,navigated:n.url}):{success:!1,error:"No URL provided"};default:return{success:!1,error:`Unknown built-in tool: ${t}`}}}const p=await F();for(const d of p){if(!d.enabled)continue;if(d.tools?.find(u=>u.name===t))try{return console.log(`[OpenLens] Calling MCP tool "${t}" on server "${d.name}"`),await pe(d.url,t,n)}catch(u){return{success:!1,error:`MCP error: ${String(u)}`}}}return{success:!1,error:`Unknown tool: ${t}`}}async function we(t,n){L={running:!0,calls:[],finalAnswer:"",error:null};const p=o.provider==="ollama"?"local":"cloud",d=await H(),g=ie(d);let u="";try{const m=await P(n,{type:"READ_PAGE",maxTokens:2e3});if(m?.success&&m.summary){u=m.summary;const h=Math.ceil(u.length/4);f({origin:new URL((await new Promise(c=>chrome.tabs.get(n,c))).url||"unknown").hostname,originType:"web",dataType:"page_content",tokenCount:h,sensitivity:"low",entryMethod:"tool_call"}),L.calls.push({toolName:"read_page",args:{},result:`Read ${h} tokens from page`,iteration:0,timestamp:Date.now()})}}catch(m){console.log("[OpenLens] Pre-read failed:",m)}const r=[{role:"system",content:"You are a helpful browser AI assistant. Be concise and specific."},{role:"user",content:t}];if($(),u)try{console.log("[OpenLens] Trying direct answer with pre-read page context...");const m=[{role:"system",content:`You are a helpful browser AI assistant analyzing a web page. Answer the user's question directly and concisely using the page content below.

Page content:
${u}`},{role:"user",content:t}],c=(await i(m)).content?.trim()||"";if(c&&!c.startsWith('{"tool"')&&!c.startsWith('{"tool"')&&c.length>10){L.finalAnswer=c,L.running=!1;const b=Math.ceil(c.length/4);w({type:"llm_prompt",origin:"openlens",detail:{mode:"direct_answer",iterations:0},tokensInvolved:b,processingLocation:p}),$(),console.log("[OpenLens] Direct answer succeeded, length:",c.length);return}console.log("[OpenLens] Direct answer was not useful, falling through to tool loop")}catch(m){console.log("[OpenLens] Direct answer failed, falling through to tool loop:",m)}const _=u?`You are a helpful browser AI assistant. You have access to tools. Use tools when needed. Be concise.

Current page content:
${u}`:"You are a helpful browser AI assistant. You have access to tools. Use tools when needed (call read_page first if you need page content). Be concise.";r[0]={role:"system",content:_};for(let m=0;m<5;m++)try{console.log(`[OpenLens] Tool loop iteration ${m+1}/5`);const h=await i(r,{tools:g});if(h.toolCalls&&h.toolCalls.length>0)for(const c of h.toolCalls){const b=c.function?.name||"",T=c.function?.arguments||{};console.log(`[OpenLens] Tool call: ${b}`,T),w({type:"tool_call_start",origin:"openlens",detail:{tool:b,args:T,iteration:m+1},processingLocation:p});const y=await he(b,T,n),k={toolName:b,args:T,result:typeof y=="object"?JSON.stringify(y).slice(0,500):String(y),iteration:m+1,timestamp:Date.now()};L.calls.push(k);const O=Math.ceil(JSON.stringify(y).length/4);f({origin:"openlens",originType:"local",dataType:`tool:${b}`,tokenCount:O,sensitivity:"low",entryMethod:"tool_call"}),w({type:"tool_call_result",origin:"openlens",detail:{tool:b,success:y?.success},tokensInvolved:O,processingLocation:p}),r.push({role:"assistant",content:`I called the tool "${b}" with args ${JSON.stringify(T)}.`}),r.push({role:"user",content:`Tool "${b}" returned: ${JSON.stringify(y).slice(0,3e3)}

Now continue answering the original question using this result.`}),$()}else{L.finalAnswer=h.content,L.running=!1;const c=Math.ceil(h.content.length/4);w({type:"llm_prompt",origin:"openlens",detail:{mode:"tool_call",iterations:m+1},tokensInvolved:c,processingLocation:p}),$(),console.log(`[OpenLens] Tool loop complete after ${m+1} iterations`);return}}catch(h){console.error("[OpenLens] Tool loop error:",h),L.error=String(h),L.running=!1,$();return}L.finalAnswer="(Reached maximum tool call iterations)",L.running=!1,$()}function $(){const t={type:"TOOL_CALL_UPDATE",state:{running:L.running,callCount:L.calls.length,calls:L.calls,finalAnswer:L.finalAnswer,error:L.error}};chrome.tabs.query({},n=>{for(const e of n)e.id&&P(e.id,t).catch(()=>{})})}const ye=(t,n)=>{try{if(t.type==="CREATE_PLAN"){console.log("[OpenLens] CREATE_PLAN, intent:",t.intent,"tabId:",t.tabId);const e=t.intent||"Analyze this page";return s.totalTokens=0,s.contextUsed=0,s.dataEntries=[],s.auditEvents=[],s.insights=[],s.sessionId=`sess_${Date.now()}`,w({type:"task_started",origin:"openlens",detail:{intent:e,provider:o.provider,model:o.model},processingLocation:o.provider==="ollama"?"local":"cloud"}),(async()=>{try{let a={title:"Unknown",url:"",pageType:"generic",tokenEstimate:0};const p=t.tabId;if(p)try{const g=new Promise(_=>setTimeout(()=>_(null),2e3)),u=P(p,{type:"READ_PAGE",maxTokens:500}).catch(()=>null),r=await Promise.race([u,g]);console.log("[OpenLens] Page read:",r?.success??"timeout"),r?.success&&(a={title:r.context?.title||"Unknown",url:r.context?.url||"",pageType:r.context?.pageType||"generic",tokenEstimate:r.context?.tokenEstimate||0})}catch{}const d=await V(e);return l={intent:e,steps:d,status:"running",pageContext:a},console.log("[OpenLens] Plan created:",d.length,"steps, page:",a.title),{plan:l}}catch(a){console.error("[OpenLens] CREATE_PLAN fatal error:",a);const p=S(e);return l={intent:e,steps:p,status:"running"},{plan:l}}})()}if(t.type==="EXECUTE_STEP")return console.log("[OpenLens] EXECUTE_STEP",t.stepIdx,"tabId:",t.tabId),(async()=>{try{let e=t.tabId;return e||(e=(await X())?.id),e?{step:await me(t.stepIdx,e)}:{step:null,error:"No active tab found"}}catch(e){return console.error("[OpenLens] EXECUTE_STEP error:",e),{step:null,error:String(e)}}})();if(t.type==="CHECK_CROSS_ORIGIN")return Promise.resolve({warning:ge(t.stepIdx)});if(t.type==="GENERATE_SHADOW_PROFILE")return Q().then(()=>({ok:!0})).catch(()=>({ok:!1}));if(t.type==="GET_SESSION_STATE")return Promise.resolve({state:s});if(t.type==="GET_PERMISSIONS")return ne(t.tabId).then(e=>({permissions:e})).catch(()=>({permissions:[]}));if(t.type==="CHECK_OLLAMA"){const e=t.endpoint||"http://localhost:11434";return fetch(`${e}/api/tags`).then(a=>({running:a.ok})).catch(()=>({running:!1}))}if(t.type==="LIST_OLLAMA_MODELS"){const e=t.endpoint||"http://localhost:11434";return fetch(`${e}/api/tags`).then(a=>a.json()).then(a=>({models:a.models||[]})).catch(()=>({models:[]}))}if(t.type==="TOOL_CALL_TASK")return console.log("[OpenLens] TOOL_CALL_TASK, intent:",t.intent),(async()=>{try{let e=t.tabId;return e||(e=(await X())?.id),e?(s.totalTokens=0,s.contextUsed=0,s.dataEntries=[],s.auditEvents=[],s.insights=[],s.sessionId=`sess_${Date.now()}`,w({type:"task_started",origin:"openlens",detail:{intent:t.intent,mode:"tool_call",provider:o.provider},processingLocation:o.provider==="ollama"?"local":"cloud"}),await we(t.intent,e),await Q(),{state:L}):{error:"No active tab found"}}catch(e){return{error:String(e)}}})();if(t.type==="GET_TOOL_CALL_STATE")return Promise.resolve({state:L});if(t.type==="GET_MCP_SERVERS")return F().then(e=>({servers:e}));if(t.type==="CONNECT_MCP_SERVER")return(async()=>{try{const{serverInfo:e,tools:a,serverId:p}=await ce(t.url),d={id:p,name:e.name||"Unknown",url:t.url,enabled:!0,status:"connected",tools:a,lastConnected:Date.now()};return await z(d),w({type:"mcp_discovered",origin:t.url,detail:{server:d.name,toolCount:a.length,tools:a.map(g=>g.name)},processingLocation:"local"}),await v(),{ok:!0,server:d}}catch(e){return{ok:!1,error:String(e)}}})();if(t.type==="DELETE_MCP_SERVER")return le(t.serverId).then(async()=>(await v(),{ok:!0}));if(t.type==="TOGGLE_MCP_SERVER")return(async()=>{const a=(await F()).find(p=>p.id===t.serverId);return a?(a.enabled=!a.enabled,await z(a),await v(),{ok:!0,enabled:a.enabled}):{ok:!1,error:"Server not found"}})();if(t.type==="OPEN_SIDEPANEL"){try{chrome.sidePanel?.open?n.tab?.windowId?chrome.sidePanel.open({windowId:n.tab.windowId}):chrome.windows.getCurrent(e=>{e.id&&chrome.sidePanel.open({windowId:e.id})}):M.sidebarAction?.open&&M.sidebarAction.open()}catch{}return Promise.resolve({ok:!0})}}catch(e){return console.error("[OpenLens] Message handler top-level error:",e),Promise.resolve({error:String(e)})}};chrome.runtime.onMessage.addListener(ye),console.log("[OpenLens] Background service worker started")});function ve(){}function j(o,...i){}const de={debug:(...o)=>j(console.debug,...o),log:(...o)=>j(console.log,...o),warn:(...o)=>j(console.warn,...o),error:(...o)=>j(console.error,...o)};let Y;try{Y=ue.main(),Y instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(o){throw de.error("The background crashed on startup!"),o}var fe=Y;return fe})();
