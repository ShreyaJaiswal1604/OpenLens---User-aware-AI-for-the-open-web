import{r as l,b as T,j as e,R as P,a as W}from"./global-BS6jmjxD.js";function D(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/^#### (.+)$/gm,'<h5 class="font-semibold text-sm mt-3 mb-1 text-gray-200">$1</h5>').replace(/^### (.+)$/gm,'<h4 class="font-semibold text-sm mt-3 mb-1 text-gray-100">$1</h4>').replace(/^## (.+)$/gm,'<h3 class="font-semibold text-base mt-4 mb-1 text-white">$1</h3>').replace(/^# (.+)$/gm,'<h2 class="font-bold text-lg mt-4 mb-1 text-white">$1</h2>').replace(/\*\*\*(.+?)\*\*\*/g,"<strong><em>$1</em></strong>").replace(/\*\*(.+?)\*\*/g,'<strong class="text-gray-100">$1</strong>').replace(/\*(.+?)\*/g,"<em>$1</em>").replace(/`(.+?)`/g,'<code class="bg-gray-800 px-1 py-0.5 rounded text-blue-300 text-xs">$1</code>').replace(/^[\*\-]\s+(.+)$/gm,'<li class="ml-4 list-disc text-gray-300">$1</li>').replace(/^\d+\.\s+(.+)$/gm,'<li class="ml-4 list-decimal text-gray-300">$1</li>').replace(/((?:<li class="ml-4 list-disc[^>]*>.*?<\/li>\s*)+)/g,'<ul class="my-1 space-y-0.5">$1</ul>').replace(/((?:<li class="ml-4 list-decimal[^>]*>.*?<\/li>\s*)+)/g,'<ol class="my-1 space-y-0.5">$1</ol>').replace(/\n\n/g,'</p><p class="mt-2">').replace(/\n/g,"<br/>")}function I({text:t,className:a=""}){return e.jsx("div",{className:`markdown-content ${a}`,dangerouslySetInnerHTML:{__html:`<p>${D(t)}</p>`}})}function H(){const[t,a]=l.useState("loading"),[c,h]=l.useState(""),[n,d]=l.useState(null),[m,b]=l.useState(-1),[A,N]=l.useState(null),[u,v]=l.useState(null),[E,p]=l.useState(null),[y,O]=l.useState(null),[o,f]=l.useState(null),$=l.useRef(null);l.useEffect(()=>{chrome.storage.local.get("setupConfig",s=>{s.setupConfig?.setupComplete?a("idle"):a("needs-setup")});const r=s=>{s.type==="TOOL_CALL_UPDATE"&&(f(s.state),!s.state.running&&(s.state.finalAnswer||s.state.error)&&a("completed"))};return chrome.runtime.onMessage.addListener(r),()=>chrome.runtime.onMessage.removeListener(r)},[]);const j=typeof T<"u"?T.runtime.sendMessage.bind(T.runtime):chrome.runtime.sendMessage.bind(chrome.runtime);async function L(){return new Promise(r=>{chrome.tabs.query({active:!0,currentWindow:!0},s=>{r(s[0]?.id||null)})})}async function M(){const r=c||"What are the key details on this page?";p(null),a("running"),f({running:!0,callCount:0,calls:[],finalAnswer:"",error:null});try{const s=await L();O(s),console.log("[OpenLens Sidebar] Starting tool task, tabId:",s);const x=await j({type:"TOOL_CALL_TASK",intent:r,tabId:s});x?.state&&f(x.state),x?.error&&p(x.error),a("completed")}catch(s){console.error("[OpenLens Sidebar] startToolTask error:",s),p(`Error: ${String(s)}`),a("completed")}}async function w(r,s,x){if(s>=r.steps.length){a("completed"),j({type:"GENERATE_SHADOW_PROFILE"}).catch(()=>{});return}const g=r.steps[s];try{const i=await j({type:"CHECK_CROSS_ORIGIN",stepIdx:s});if(i?.warning){N(i.warning);return}}catch{}if(g.isWriteAction){v(g);return}await C(r,s,x)}async function C(r,s,x){const g=x||y||await L();try{console.log("[OpenLens Sidebar] EXECUTE_STEP",s,"tabId:",g);const i=await j({type:"EXECUTE_STEP",stepIdx:s,tabId:g});if(console.log("[OpenLens Sidebar] EXECUTE_STEP response:",i?.step?.status),i?.step){const k={...r};k.steps[s]=i.step,d({...k}),b(s+1),setTimeout(()=>{$.current?.lastElementChild?.scrollIntoView({behavior:"smooth"})},100),setTimeout(()=>w(k,s+1,g),800)}else p(i?.error||"Step failed"),b(s+1),setTimeout(()=>w(r,s+1,g),500)}catch(i){console.error("[OpenLens Sidebar] executeCurrentStep error:",i),p(`Step error: ${String(i)}`),a("completed")}}function R(r){if(N(null),r==="stop"){a("completed");return}n&&C(n,m,y)}function _(r){if(v(null),r==="skip"){n&&(n.steps[m].status="skipped",d({...n}),b(m+1),w(n,m+1,y));return}n&&C(n,m,y)}function S(){a("idle"),d(null),b(-1),N(null),v(null),h(""),p(null),O(null),f(null)}return t==="loading"?e.jsx("div",{className:"min-h-screen bg-gray-950 text-white flex items-center justify-center",children:e.jsx("div",{className:"text-lg animate-pulse",children:"Loading..."})}):t==="needs-setup"?e.jsxs("div",{className:"min-h-screen bg-gray-950 text-white flex flex-col items-center justify-center p-8 gap-4",children:[e.jsx("h2",{className:"text-lg font-semibold",children:"Setup Required"}),e.jsx("p",{className:"text-sm text-gray-400 text-center",children:"Open the OpenLens popup to configure your hardware and select an AI model first."}),e.jsx("button",{onClick:()=>{chrome.storage.local.get("setupConfig",r=>{r.setupConfig?.setupComplete&&a("idle")})},className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium",children:"Refresh"})]}):e.jsxs("div",{className:"min-h-screen bg-gray-950 text-white",children:[e.jsxs("div",{className:"px-4 py-3 border-b border-gray-800 flex items-center justify-between",children:[e.jsxs("h1",{className:"font-bold flex items-center gap-2",children:[e.jsx("img",{src:"/logo.webp",alt:"",className:"w-5 h-5 rounded"}),"OpenLens"]}),t!=="idle"&&e.jsx("button",{onClick:S,className:"text-xs text-gray-500 hover:text-gray-300",children:"Reset"})]}),e.jsxs("div",{className:"p-4",children:[t==="idle"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-400",children:"Enter a task. Your AI uses built-in page tools + any connected MCP server tools to answer."}),e.jsx("textarea",{value:c,onChange:r=>h(r.target.value),placeholder:"What are the key details on this page?",className:"w-full h-24 bg-gray-900 border border-gray-700 rounded-lg p-3 text-sm resize-none focus:outline-none focus:border-blue-500"}),e.jsx("button",{onClick:M,className:"w-full py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium",children:"Start Task"}),e.jsxs("div",{className:"bg-gray-900/50 rounded-lg p-3 text-xs text-gray-500 space-y-1",children:[e.jsx("strong",{children:"How it works:"}),e.jsxs("ul",{className:"list-disc pl-4 space-y-0.5",children:[e.jsx("li",{children:"LLM decides which tools to call automatically"}),e.jsx("li",{children:"Built-in: read page, search, extract data, navigate"}),e.jsx("li",{children:"Connect MCP servers for more tools (popup → MCP tab)"}),e.jsx("li",{children:"Every tool call shown transparently"})]})]})]}),t==="planning"&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 gap-4",children:[e.jsx("div",{className:"text-sm animate-pulse text-gray-300",children:"..."}),e.jsx("div",{className:"text-sm text-gray-400",children:"Reading page & planning steps..."})]}),(t==="running"||t==="completed")&&o&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-900 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Task (Tool Mode)"}),e.jsx("div",{className:"text-sm",children:c||"Analyzing page..."})]}),o.calls.map((r,s)=>e.jsx(q,{call:r},s)),o.running&&e.jsxs("div",{className:"flex items-center gap-3 py-4 justify-center",children:[e.jsx("div",{className:"text-sm animate-spin text-gray-300",children:"↻"}),e.jsxs("span",{className:"text-sm text-gray-400",children:["LLM thinking... (",o.callCount," tool",o.callCount!==1?"s":""," called)"]})]}),o.finalAnswer&&e.jsxs("div",{className:"bg-blue-900/20 border border-blue-700 rounded-lg p-4",children:[e.jsx("div",{className:"text-xs text-blue-400 mb-2 font-semibold",children:"Final Answer"}),e.jsx(I,{text:o.finalAnswer,className:"text-sm text-gray-200"})]}),o.error&&e.jsx("div",{className:"bg-red-900/20 border border-red-700 rounded-lg p-3 text-sm text-red-300",children:o.error}),t==="completed"&&e.jsxs("div",{className:"bg-green-900/20 border border-green-700 rounded-lg p-4 text-center space-y-2",children:[e.jsx("div",{className:"font-semibold text-green-300",children:"Task Complete"}),e.jsxs("p",{className:"text-sm text-gray-400",children:[o.callCount," tool call",o.callCount!==1?"s":""," made. Check the Shadow Profile to see what your AI inferred."]}),e.jsx("button",{onClick:S,className:"mt-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm",children:"Run Another Task"})]})]}),(t==="running"||t==="completed")&&!o&&n&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-900 rounded-lg p-3",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-1",children:"Task"}),e.jsx("div",{className:"text-sm",children:n.intent}),n.pageContext&&n.pageContext.title!=="Unknown"&&e.jsxs("div",{className:"mt-2 pt-2 border-t border-gray-800 flex items-center gap-2 text-xs text-gray-500",children:[e.jsx("span",{className:"truncate",children:n.pageContext.title}),e.jsx("span",{className:"ml-auto shrink-0 px-1.5 py-0.5 rounded bg-gray-800 text-gray-400",children:n.pageContext.pageType}),e.jsxs("span",{className:"shrink-0 text-gray-600",children:["~",n.pageContext.tokenEstimate," tokens"]})]})]}),e.jsx("div",{ref:$,className:"space-y-3",children:n.steps.map((r,s)=>e.jsx(U,{step:r,isActive:s===m&&t==="running"},r.id))}),A&&e.jsxs("div",{className:"bg-yellow-900/30 border border-yellow-600 rounded-lg p-4 space-y-3",children:[e.jsx("div",{className:"flex items-center gap-2 font-semibold text-yellow-300",children:"Cross-Origin Data Merge"}),e.jsx("p",{className:"text-sm text-yellow-200",children:A}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>R("allow"),className:"flex-1 py-2 bg-yellow-600 hover:bg-yellow-700 rounded text-sm font-medium",children:"Allow & Continue"}),e.jsx("button",{onClick:()=>R("stop"),className:"flex-1 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm",children:"Stop Task"})]})]}),u&&e.jsxs("div",{className:"bg-red-900/20 border border-red-600/50 rounded-lg p-4 space-y-3",children:[e.jsx("div",{className:"flex items-center gap-2 font-semibold text-red-300",children:"Write Action — Approval Required"}),e.jsx("p",{className:"text-sm text-gray-300",children:u.description}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Tool: ",e.jsx("span",{className:"text-gray-400",children:u.tool}),u.toolParams&&Object.keys(u.toolParams).length>0&&e.jsxs("span",{children:[" | Params: ",JSON.stringify(u.toolParams)]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>_("approve"),className:"flex-1 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm font-medium",children:"Approve"}),e.jsx("button",{onClick:()=>_("skip"),className:"flex-1 py-2 bg-gray-700 hover:bg-gray-600 rounded text-sm",children:"Skip"})]})]}),t==="completed"&&e.jsxs("div",{className:"bg-green-900/20 border border-green-700 rounded-lg p-4 text-center space-y-2",children:[e.jsx("div",{className:"font-semibold text-green-300",children:"Task Complete"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Check the Shadow Profile to see what your AI inferred about you."}),e.jsx("button",{onClick:S,className:"mt-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded text-sm",children:"Run Another Task"})]})]}),E&&e.jsx("div",{className:"mt-4 bg-red-900/20 border border-red-700 rounded-lg p-3 text-sm text-red-300",children:E})]})]})}function q({call:t}){const[a,c]=l.useState(!1),n={read_page:"R",extract_data:"D",find_on_page:"F",navigate:"N",fill_form:"W",click_element:"C"}[t.toolName]||"T",d=typeof t.args=="object"?JSON.stringify(t.args):String(t.args),m=new Date(t.timestamp).toLocaleTimeString();return e.jsxs("div",{className:"rounded-lg border border-gray-700 bg-gray-900 p-3",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-xs font-mono bg-gray-800 px-1.5 py-0.5 rounded text-blue-400",children:n}),e.jsx("span",{className:"font-medium text-sm",children:t.toolName}),e.jsxs("span",{className:"ml-auto text-xs text-gray-500",children:["#",t.iteration," ",m]})]}),d!=="{}"&&e.jsx("div",{className:"text-xs text-gray-400 ml-6 truncate",children:d.slice(0,100)}),e.jsx("div",{className:"mt-1 ml-6",children:e.jsx("button",{onClick:()=>c(!a),className:"text-xs text-blue-400 hover:text-blue-300",children:a?"Hide result":"Show result"})}),a&&e.jsx("div",{className:"mt-2 ml-6 bg-gray-800/50 border border-gray-700 rounded p-2.5 text-xs text-gray-300 max-h-40 overflow-y-auto",children:e.jsx("pre",{className:"whitespace-pre-wrap break-all",children:typeof t.result=="string"?t.result.slice(0,800):JSON.stringify(t.result,null,2).slice(0,800)})})]})}function U({step:t,isActive:a}){const[c,h]=l.useState(!1),n={pending:"·",running:"↻",awaiting_approval:"!",completed:"✓",skipped:"→"}[t.status],d={page_read:"R",page_action:"A",data_send:"C"}[t.requiredPermission]||"?";return e.jsxs("div",{className:`rounded-lg border p-3 transition-all ${a?"border-blue-500 bg-blue-900/20":t.status==="completed"?"border-green-800 bg-gray-900":t.status==="skipped"?"border-gray-700 bg-gray-900/50 opacity-60":"border-gray-800 bg-gray-900"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:a?"animate-spin":"",children:n}),e.jsx("span",{className:"font-medium text-sm",children:t.title}),e.jsxs("span",{className:"ml-auto flex items-center gap-1.5",children:[t.isWriteAction&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-red-900/40 text-red-400 font-semibold",children:"WRITE"}),e.jsxs("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-gray-800 text-gray-500",title:`Permission: ${t.requiredPermission}`,children:[d," ",t.tool]}),t.tokens>0&&e.jsxs("span",{className:"text-xs text-gray-500",children:[t.tokens," tk"]})]})]}),e.jsx("p",{className:"text-xs text-gray-400 ml-6",children:t.description}),t.llmOutput&&e.jsx("div",{className:"mt-2 ml-6 bg-gray-800 rounded p-2.5",children:e.jsx(I,{text:t.llmOutput,className:"text-sm text-gray-200"})}),t.result&&t.status==="completed"&&e.jsxs("div",{className:"mt-2 ml-6 flex gap-2",children:[t.llmOutput&&e.jsx("button",{onClick:()=>h(!c),className:"text-xs text-blue-400 hover:text-blue-300",children:c?"Hide data":"Show data used"}),t.origin&&e.jsxs("span",{className:"text-xs text-gray-600",children:["from ",t.origin]})]}),c&&t.result&&e.jsxs("div",{className:"mt-2 ml-6 bg-gray-800/50 border border-gray-700 rounded p-2.5 text-xs text-gray-300 max-h-40 overflow-y-auto",children:[e.jsx("strong",{children:"Raw data:"}),e.jsx("pre",{className:"mt-1 whitespace-pre-wrap break-all",children:JSON.stringify(t.result,null,2).slice(0,1e3)})]})]})}P.createRoot(document.getElementById("root")).render(e.jsx(W.StrictMode,{children:e.jsx(H,{})}));
